syntax = "proto3";

option go_package = "github.com/packethost/rover/protos/workflow";

package github.com.packethost.rover.protos.workflow;

import "google/protobuf/timestamp.proto";

service WorkflowSvc {
    rpc CreateWorkflow(CreateRequest) returns (CreateResponse);
    rpc GetWorkflow(GetRequest) returns (Workflow);
    rpc DeleteWorkflow(GetRequest) returns (Empty);
    rpc ListWorkflows(Empty) returns (stream Workflow);
    rpc GetWorkflowContext(GetRequest) returns (WorkflowContext);
    rpc ShowWorkflowEvents(GetRequest) returns (stream WorkflowActionStatus);
}

message Empty {
}

message Workflow {
    string id = 1;
    string template = 2;
    string target = 3;
    State state = 4;
    google.protobuf.Timestamp createdAt = 5;
    google.protobuf.Timestamp updatedAt = 6;
    google.protobuf.Timestamp deletedAt = 7;  
    string data = 8; 
}

enum State {
    PENDING = 0;
    RUNNING = 1; 
    FAILED = 2;
    TIMEOUT = 3;
    SUCCESS = 4;
} 

message CreateRequest {
    string template = 1;
    string target = 2;
}

message CreateResponse {
	string id = 1;
}

message GetRequest {
    string id = 1;
}

enum ActionState {
    ACTION_PENDING = 0;
    ACTION_IN_PROGRESS = 1;
    ACTION_SUCCESS = 2;
    ACTION_FAILED = 3;
    ACTION_TIMEOUT = 4;
}

message WorkflowContext {
    string workflow_id = 1;
    string current_worker = 2;
    string current_task = 3;
    string current_action = 4;
    int64 current_action_index = 5;
    ActionState current_action_state = 6;
    int64 total_number_of_actions = 7;
}

message WorkflowActionStatus {
    string workflow_id = 1;
    string task_name = 2;
    string action_name = 3;
    ActionState action_status = 4;
    int64 seconds = 5;
    string message = 6;
    google.protobuf.Timestamp createdAt = 7;
    string worker_id = 8;
}
